
# Copilot Instructions for v-chatgpt-social-status-feeds

## Big Picture & Architecture
This is a modular PHP app for managing, scheduling, and distributing social media status updates. All source code lives under `root/` and follows a strict MVC pattern:
- **Controllers** (`root/app/Controllers/`): Handle HTTP requests, session logic, and route mapping. Example: `AuthController.php` for login/session, `FeedController.php` for RSS feeds.
- **Models** (`root/app/Models/`): Encapsulate all database logic. Use the custom `Database` class (Doctrine DBAL wrapper) for queries and transactions. Example: `User.php`, `Account.php`.
- **Views** (`root/app/Views/`): Render HTML templates. Use partials and layouts for reuse.
- **Core** (`root/app/Core/`): Shared utilities (routing, error logging, CSRF, mail, etc.).
- **Services** (`root/app/Services/`): Business logic (status scheduling, queue, security, caching).

**Configuration:**
- Centralized in `root/config.php` (DB credentials, API keys, session/cookie settings, cache TTLs).
- All environment-sensitive data should be set here or via Docker env vars.

**Caching:**
- Two-tier caching system: L1 (in-memory static arrays), L2 (APCu persistent cache)
- Managed by `CacheService.php` singleton in Services
- Automatically falls back to in-memory when APCu unavailable
- All Models (`User`, `Account`, `Status`) use two-tier caching for frequently accessed data
- RSS feed XML output is cached for instant delivery
- Cache TTLs configurable via `CACHE_TTL_*` constants in `config.php`

**Routing:**
- Managed by `Router.php` in Core. Controllers define routes and map to views.

**Database:**
- MariaDB backend. Schema in `install.sql`. All access via the `Database` class (uses Doctrine DBAL).
- Status jobs are queued using Enqueue DBAL transport; processed by `cron.php`.

## Developer Workflows
**Local Setup:**
1. Start with Docker: `docker compose up`
2. Access at `http://localhost`
3. Install DB via `/install.php`

**Cron Jobs:**
- Set up two schedules for `cron.php` (daily/hourly) to purge, reset, and process status jobs.

**Debugging:**
- Use `ErrorMiddleware::logMessage()` for error/debug logs. Check `logs/` if enabled.

**Testing:**
- No automated tests; use manual testing and DB inspection.

## Project-Specific Conventions
- All forms must include a CSRF token (see `Csrf.php`). Validate in controllers.
- Input validation: Use regex for usernames/passwords in `UsersController.php`.
- Session management: Sessions start in `config.php`; always call `session_regenerate_id(true)` after login.
- Cookie security: Set `httponly`, `secure`, and `SameSite=Lax` in config.
- IP blacklisting: Use `Utility.php` for suspicious IPs.
- All DB access must use the `Database` class for consistency and error handling.
- Caching: Use `CacheService` for persistent data. Models implement two-tier caching automatically. Cache invalidation happens in Model mutation methods (create, update, delete).

## Integration Points & External Dependencies
- **OpenAI API:** Managed by `ApiHandler.php` for post/image generation.
- **Enqueue DBAL:** Used for status job queueing (see `QueueService.php`).
- **PHPMailer:** For email notifications (see `Mailer.php` and templates).
- **RSS Feeds:** Generated by `FeedController::outputRssFeed()`; feeds at `/feeds/{user}/{account}` and `/feeds/{user}/all`.

## Key Files & Examples
- `root/config.php`: All config and environment settings
- `root/app/Controllers/AuthController.php`: Auth/session logic
- `root/app/Models/User.php`: User DB logic with two-tier caching
- `root/app/Models/Account.php`: Account DB logic with two-tier caching
- `root/app/Models/Status.php`: Status DB logic with APCu caching
- `root/app/Services/CacheService.php`: APCu cache abstraction layer
- `root/app/Core/Utility.php`: RSS, IP blacklist, helpers
- `root/app/Services/StatusService.php`: Status scheduling/queue
- `root/public/install.php`: DB install
- `root/cron.php`: Cron job processor

## Notes
- Strictly follow MVC and use provided service/util classes.
- Never hardcode secrets; use config or env vars.
- Update this file as the codebase evolves.
